# Implementation Roadmap

Complete implementation plan for OCI Free Tier Kubernetes cluster.

## Current State

✅ **Completed:**
- Layer 1 (partial): OCI infrastructure provisioning (`tofu/oci/`)
- Availability checker script
- Development environment (devbox + pre-commit)
- Setup automation scripts
- Flux GitOps repository structure

❌ **Missing:**
- Packer image building (base + Proxmox)
- Custom image upload/import to OCI
- Layer 2: Proxmox cluster automation (`tofu/proxmox-cluster/`)
- Layer 3: Talos Kubernetes automation (`tofu/talos/`)
- Monitoring integration (Grafana Alloy)
- End-to-end deployment orchestration

## Implementation Phases

### Phase 1: Custom Image Building

**Goal**: Build hardened base and Proxmox images for deployment

**Tasks**:
1. Create `packer/base-hardened.pkr.hcl`
   - Source: Debian 12 netinstall
   - Packages: SSH, Tailscale, minimal utilities
   - Hardening: SSH key-only, firewall, auto-updates
   - Output: `base-hardened.qcow2` (<10GB)

2. Create `packer/proxmox-ampere.pkr.hcl`
   - Source: `base-hardened.qcow2`
   - Packages: Proxmox VE, Ceph (ceph-mon, ceph-osd, ceph-mgr)
   - Scripts: tteck/Proxmox helper scripts (post-install, microcode)
   - Output: `proxmox-ampere.qcow2` (<10GB)

3. Create `scripts/build-images.sh`
   - Build both images sequentially
   - Upload to OCI Object Storage
   - Create OCI custom images
   - Validate total size <20GB
   - Output OCIDs for use in OpenTofu

**Deliverables**:
- `packer/base-hardened.pkr.hcl`
- `packer/proxmox-ampere.pkr.hcl`
- `scripts/build-images.sh`
- Updated `.gitignore` for Packer artifacts

### Phase 2: Enhanced OCI Infrastructure

**Goal**: Complete Layer 1 with custom images, reserved IPs, DNS

**Tasks**:
1. Add custom image data sources to `tofu/oci/data.tf`
   - Reference OCIDs from Phase 1
   - Fallback to platform images if custom not available

2. Add reserved IP resources to `tofu/oci/main.tf`
   - Reserved IP #1: Bastion (static SSH)
   - Reserved IP #2: K8s ingress (LoadBalancer)
   - Attach to appropriate instances

3. Add DNS zone resource (optional)
   - `oci_dns_zone` for custom domain
   - DNS records for services

4. Add Tailscale cloud-init provisioning
   - Inject Tailscale authkey via cloud-init
   - Auto-join mesh on first boot

**Deliverables**:
- Updated `tofu/oci/main.tf`
- Updated `tofu/oci/data.tf`
- Updated `tofu/oci/variables.tf` (Tailscale authkey)
- Updated `tofu/oci/outputs.tf` (reserved IPs, DNS)

### Phase 3: Proxmox Cluster Automation

**Goal**: Automate Proxmox cluster formation and Ceph configuration

**Tasks**:
1. Create `tofu/proxmox-cluster/` module
   - Providers: SSH, Ansible, or null_resource with remote-exec
   - Inputs: Instance IPs from Layer 1 (remote state or manual)

2. Create cluster formation automation
   - `pvecm create` on first node
   - `pvecm add` on remaining nodes
   - Verify quorum

3. Create Ceph configuration automation
   - `pveceph install` on all nodes
   - `pveceph init` on first node
   - `pveceph mon create` on all nodes
   - `pveceph osd create` for storage devices
   - `pveceph pool create` for VM storage

4. Deploy Tailscale LXC containers
   - Create LXC template
   - Deploy to each Proxmox node
   - Join Tailscale mesh

5. Add verification tests
   - Cluster quorum check
   - Ceph health check
   - VM live migration test

**Deliverables**:
- `tofu/proxmox-cluster/main.tf`
- `tofu/proxmox-cluster/providers.tf`
- `tofu/proxmox-cluster/variables.tf`
- `tofu/proxmox-cluster/outputs.tf`
- Ansible playbook or provisioning scripts
- Verification scripts

### Phase 4: Talos Kubernetes Deployment

**Goal**: Automate Talos VM creation and K8s bootstrap with Flux

**Tasks**:
1. Create `tofu/talos/` module
   - Provider: `bpg/proxmox` for Proxmox API
   - Provider: Kubernetes for Age key injection
   - Inputs: Proxmox API endpoint from Layer 2

2. Create Talos VM resources
   - Download Talos nocloud image from factory.talos.dev
   - Create 3 VMs (control plane nodes)
   - Inject machine configs via cloud-init

3. Create Talos machine config template
   - `talos-config.yaml.tpl` with variables
   - Cilium CNI (kube-proxy-free)
   - Flux bootstrap URLs
   - External cloud provider enabled

4. Add Age key injection
   - Wait for Flux namespace
   - Create `sops-age` secret
   - Read from `age-key.txt` (generated by `scripts/setup-flux.sh`)

5. Configure ingress with reserved IP #2
   - Option A: 1:1 NAT via Proxmox iptables
   - Option B: OCI CCM LoadBalancer service

**Deliverables**:
- `tofu/talos/main.tf`
- `tofu/talos/providers.tf`
- `tofu/talos/variables.tf`
- `tofu/talos/outputs.tf`
- `tofu/talos/talos-config.yaml.tpl`
- Kubeconfig output for local access

### Phase 5: Monitoring Integration

**Goal**: Deploy Grafana Cloud agents and dashboards

**Tasks**:
1. Add Grafana Alloy to Flux repository
   - HelmRelease in `infrastructure/base/grafana-alloy/`
   - Values with Grafana Cloud credentials (SOPS-encrypted)
   - Collectors for:
     - Proxmox API (host metrics)
     - Talos nodes (node-exporter)
     - K8s cluster (kube-state-metrics)
     - Application logs

2. Create Grafana Cloud dashboard configs
   - Proxmox VE dashboard
   - Ceph cluster health
   - Kubernetes overview
   - Talos node metrics
   - Application logs (Loki)

3. Add to Flux deployment
   - Kustomization for monitoring stack
   - Deploy after infrastructure is ready

**Deliverables**:
- `infrastructure/base/grafana-alloy/` in Flux repo
- Dashboard JSON files
- SOPS-encrypted Grafana Cloud secrets
- Documentation for dashboard import

### Phase 6: End-to-End Orchestration

**Goal**: Single-command deployment from scratch

**Tasks**:
1. Create `scripts/deploy.sh` master script
   - Run all phases in order
   - Wait for health checks between phases
   - Output progress and status
   - Handle errors gracefully

2. Add validation scripts
   - `scripts/validate-phase1.sh` - Image sizes
   - `scripts/validate-phase2.sh` - OCI resources
   - `scripts/validate-phase3.sh` - Proxmox cluster
   - `scripts/validate-phase4.sh` - K8s cluster
   - `scripts/validate-phase5.sh` - Grafana metrics
   - `scripts/validate-cost.sh` - Verify $0.00 billing

3. Update documentation
   - README: High-level quick start
   - DEVELOPMENT.md: Dev environment setup
   - DEPLOYMENT.md: Detailed phase-by-phase guide
   - TROUBLESHOOTING.md: Common issues

**Deliverables**:
- `scripts/deploy.sh`
- `scripts/validate-*.sh`
- Updated documentation
- End-to-end workflow diagram

## Success Criteria

### Minimal Viable Product (MVP)
- [ ] All 5 phases automated via scripts/OpenTofu
- [ ] Zero manual `vim`/`sed`/`kubectl` commands
- [ ] Single `./scripts/deploy.sh` deploys full stack
- [ ] Verification scripts pass for all phases
- [ ] Cost verification shows $0.00
- [ ] Documentation complete and accurate

### Stretch Goals
- [ ] CI/CD pipeline for image building (GitHub Actions)
- [ ] Automated testing in ephemeral OCI tenancy
- [ ] Backup/restore procedures
- [ ] Disaster recovery runbook
- [ ] Cost monitoring dashboard
- [ ] Alert notifications (Grafana → Slack/Discord)

## Timeline Estimate

**Phase 1**: 4-6 hours (Packer configuration + testing)  
**Phase 2**: 2-3 hours (OCI enhancements)  
**Phase 3**: 6-8 hours (Proxmox automation, most complex)  
**Phase 4**: 4-6 hours (Talos deployment)  
**Phase 5**: 2-3 hours (Monitoring setup)  
**Phase 6**: 3-4 hours (Orchestration + docs)  

**Total**: ~20-30 hours for complete implementation

## Next Steps

1. Review and approve this roadmap
2. Start with Phase 1 (Packer images)
3. Test each phase independently before moving to next
4. Commit working code incrementally
5. Update ROADMAP.md as phases complete

---

**Note**: This replaces the partial setup currently in place. We'll build the complete automated workflow step by step.
